<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>Hero Game</title>
    <script src="https://cdn.jsdelivr.net/npm/phaser@3.60.0/dist/phaser-arcade-physics.min.js"></script>
    <style>
        body { margin: 0; background-color: #222; display: flex; justify-content: center; align-items: center; height: 100vh; }
    </style>
</head>
<body>
    <script>
        const config = {
            type: Phaser.CANVAS, 
            width: 800,
            height: 600,
            backgroundColor: '#2d3436',
            physics: {
                default: 'arcade',
                arcade: { debug: false }
            },
            scene: { preload, create, update }
        };

        const game = new Phaser.Game(config);
        let player, cursors, fomeText, paredes, npc;
        let fome = 100;

        const mapa = [
            [1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1],
            [1,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1],
            [1,0,1,0,1,0,1,1,1,1,0,1,1,1,1,1,0,1,0,1],
            [1,0,1,0,0,0,0,0,0,1,0,0,0,0,0,1,0,1,0,1],
            [1,0,1,1,1,1,1,1,0,1,1,1,1,1,0,1,0,1,0,1],
            [1,0,0,0,0,0,0,1,0,0,0,0,0,1,0,0,0,1,0,1],
            [1,1,1,1,1,1,0,1,1,1,1,1,0,1,1,1,1,1,0,1],
            [1,0,0,0,0,1,0,0,0,0,0,1,0,0,0,0,0,0,0,1],
            [1,0,1,1,0,1,1,1,1,1,0,1,1,1,1,1,1,1,0,1],
            [1,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,1],
            [1,0,1,0,1,1,1,1,1,1,1,1,1,1,1,1,0,1,0,1],
            [1,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1],
            [1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1]
        ];

        function preload() {
            this.load.image('boneco', 'hero_all_black.png');

            let wallCanvas = this.textures.createCanvas('wallTex', 40, 40);
            wallCanvas.context.fillStyle = '#636e72';
            wallCanvas.context.fillRect(0, 0, 38, 38);
            wallCanvas.refresh();

            let foodCanvas = this.textures.createCanvas('foodTex', 16, 16);
            foodCanvas.context.fillStyle = '#2ecc71';
            foodCanvas.context.beginPath();
            foodCanvas.context.arc(8, 8, 8, 0, Math.PI * 2);
            foodCanvas.context.fill();
            foodCanvas.refresh();

            let npcCanvas = this.textures.createCanvas('npcTex', 30, 30);
            npcCanvas.context.fillStyle = '#ff0000';
            npcCanvas.context.fillRect(0, 0, 30, 30);
            npcCanvas.refresh();
        }

        function create() {
            paredes = this.physics.add.staticGroup();
            for (let row = 0; row < mapa.length; row++) {
                for (let col = 0; col < mapa[row].length; col++) {
                    if (mapa[row][col] === 1) {
                        paredes.create(col * 40 + 20, row * 40 + 20, 'wallTex');
                    }
                }
            }

            player = this.physics.add.sprite(60, 60, 'boneco');
            player.setDisplaySize(45, 45);
            // Hitbox um pouco menor para o player não trancar nas quinas
            player.body.setSize(190, 230);
            player.setCollideWorldBounds(true);

            npc = this.physics.add.sprite(400, 300, 'npcTex');
            npc.setCollideWorldBounds(true);
            npc.setImmovable(true); 
            npc.setBounce(0.1);
            // Hitbox menor para o NPC navegar melhor no labirinto
            npc.body.setSize(35, 35);

            this.physics.add.collider(player, paredes);
            this.physics.add.collider(player, npc); 
            
            // Lógica para o NPC não ficar preso na parede
            this.physics.add.collider(npc, paredes, () => {
                // Pequeno "teleporte" de 2px para garantir que ele descole da parede
                if (npc.body.touching.left) npc.x += 2;
                if (npc.body.touching.right) npc.x -= 2;
                if (npc.body.touching.up) npc.y += 2;
                if (npc.body.touching.down) npc.y -= 2;
                
                mudarDirecaoNPC();
            });

            const mudarDirecaoNPC = () => {
                if (fome <= 0) return;
                const escolhas = [
                    {x: 120, y: 0}, {x: -120, y: 0}, 
                    {x: 0, y: 120}, {x: 0, y: -120}
                ];
                const dir = Phaser.Utils.Array.GetRandom(escolhas);
                npc.setVelocity(dir.x, dir.y);
            };

            mudarDirecaoNPC();
            this.time.addEvent({
                delay: 2500,
                callback: mudarDirecaoNPC,
                loop: true
            });

            const foods = this.physics.add.group();
            const gerarComida = () => {
                let r, c;
                do {
                    r = Phaser.Math.Between(1, mapa.length - 2);
                    c = Phaser.Math.Between(1, mapa[0].length - 2);
                } while (mapa[r][c] !== 0);
                foods.create(c * 40 + 20, r * 40 + 20, 'foodTex');
            }
            for(let i = 0; i < 6; i++) gerarComida();

            cursors = this.input.keyboard.createCursorKeys();
            fomeText = this.add.text(20, 20, 'FOME: 100%', { 
                fontSize: '24px', 
                fill: '#fff', 
                backgroundColor: '#00000088',
                padding: { x: 10, y: 5 }
            });

            this.physics.add.overlap(player, foods, (p, f) => {
                f.destroy();
                fome = Math.min(fome + 20, 100);
                gerarComida();
            });

            this.time.addEvent({
                delay: 1000,
                callback: () => { if(fome > 0) fome -= 1.5; },
                loop: true
            });
        }

        function update() {
            const speed = 200;
            player.setVelocity(0);

            if (fome > 0) {
                if (cursors.left.isDown) player.setVelocityX(-speed);
                else if (cursors.right.isDown) player.setVelocityX(speed);
                if (cursors.up.isDown) player.setVelocityY(-speed);
                else if (cursors.down.isDown) player.setVelocityY(speed);
                
                // Normaliza para não correr mais rápido na diagonal
                if (player.body.velocity.x !== 0 && player.body.velocity.y !== 0) {
                    player.body.velocity.normalize().scale(speed);
                }
            }

            fomeText.setText('FOME: ' + Math.floor(fome) + '%');
            
            if (fome <= 0) {
                fomeText.setText('FIM DE JOGO!');
                player.setTint(0xff0000);
                this.physics.pause();
                npc.setVelocity(0, 0);
            }
        }
    </script>
</body>
</html>