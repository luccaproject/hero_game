<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Hero Game - Ajustado</title>
    <script src="https://cdn.jsdelivr.net/npm/phaser@3.60.0/dist/phaser-arcade-physics.min.js"></script>
    <style>
        body { 
            margin: 0; 
            padding: 0;
            background-color: #111; 
            height: 100vh; 
            width: 100vw;
            overflow: hidden; 
            font-family: Arial, sans-serif;
            display: flex;
            justify-content: center;
            align-items: center;
            touch-action: none; 
        }

        /* Contêiner que segura o jogo */
        #game-container {
            position: relative;
            width: 100%;
            height: 100%;
            display: flex;
            justify-content: center;
            align-items: center;
            /* Garante que o canvas não estoure a tela */
            overflow: hidden; 
        }

        /* Estilo para dar destaque ao canvas do jogo (opcional, ajuda a ver o centro) */
        canvas {
            box-shadow: 0 0 20px rgba(0,0,0,0.5);
            border-radius: 4px;
        }

        /* --- INTERFACE MÓVEL (HUD) --- */
        .controls-container {
            position: absolute;
            top: 0; left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none; 
            z-index: 100;
            display: none;
        }

        .btn {
            background: rgba(255, 255, 255, 0.15);
            border: 2px solid rgba(255, 255, 255, 0.4);
            backdrop-filter: blur(2px);
            border-radius: 12px;
            color: white;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 24px;
            user-select: none;
            pointer-events: auto; 
            cursor: pointer;
            touch-action: manipulation;
            box-shadow: 0 4px 6px rgba(0,0,0,0.3);
            /* Transição suave ao apertar */
            transition: transform 0.1s, background 0.1s;
        }
        
        .btn:active { 
            background: rgba(255, 255, 255, 0.4); 
            transform: scale(0.95);
        }

        /* --- AQUI ESTÁ A MUDANÇA DOS BOTÕES --- */
        #dpad {
            position: absolute;
            /* Levantei de 30px para 120px para ficar mais confortável */
            bottom: 120px; 
            /* Afastei um pouco mais da esquerda também */
            left: 40px;
            width: 160px;
            height: 160px;
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            grid-template-rows: 1fr 1fr 1fr;
            gap: 5px;
        }
        
        #btn-up { grid-column: 2; grid-row: 1; }
        #btn-left { grid-column: 1; grid-row: 2; }
        #btn-right { grid-column: 3; grid-row: 2; }
        #btn-down { grid-column: 2; grid-row: 3; }

        #btn-pause {
            position: absolute;
            top: 20px;
            right: 20px;
            width: 50px;
            height: 50px;
            border-radius: 50%;
            font-size: 16px;
            font-weight: bold;
        }

        #btn-reset {
            position: absolute;
            /* Centralizado perfeitamente no meio da tela */
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 220px;
            height: 70px;
            background-color: #e74c3c;
            font-weight: bold;
            display: none; 
            z-index: 200;
            font-size: 20px;
            box-shadow: 0 0 15px rgba(231, 76, 60, 0.6);
        }
    </style>
</head>
<body>

    <div id="game-container">
        <div class="controls-container" id="mobile-controls">
            <div id="btn-pause" class="btn">||</div>
            <div id="btn-reset" class="btn">REINICIAR JOGO</div>
            <div id="dpad">
                <div id="btn-up" class="btn">▲</div>
                <div id="btn-left" class="btn">◄</div>
                <div id="btn-right" class="btn">►</div>
                <div id="btn-down" class="btn">▼</div>
            </div>
        </div>
    </div>

    <script>
        // --- DETECÇÃO DE DISPOSITIVO DE TOQUE ---
        const isTouchDevice = (('ontouchstart' in window) || (navigator.maxTouchPoints > 0));
        
        if (isTouchDevice) {
            document.getElementById('mobile-controls').style.display = 'block';
        }

        // --- CONTROLES VIRTUAIS ---
        let moveLeft = false, moveRight = false, moveUp = false, moveDown = false;

        function setupBtn(id, dir) {
            const btn = document.getElementById(id);
            const start = (e) => { if(e.cancelable) e.preventDefault(); setMove(dir, true); };
            const end = (e) => { if(e.cancelable) e.preventDefault(); setMove(dir, false); };
            
            btn.addEventListener('touchstart', start, {passive: false});
            btn.addEventListener('touchend', end);
            btn.addEventListener('mousedown', start);
            btn.addEventListener('mouseup', end);
            btn.addEventListener('mouseleave', end); 
        }

        function setMove(dir, state) {
            if(dir === 'left') moveLeft = state;
            if(dir === 'right') moveRight = state;
            if(dir === 'up') moveUp = state;
            if(dir === 'down') moveDown = state;
        }

        if (isTouchDevice) {
            setupBtn('btn-left', 'left');
            setupBtn('btn-right', 'right');
            setupBtn('btn-up', 'up');
            setupBtn('btn-down', 'down');

            const btnPause = document.getElementById('btn-pause');
            btnPause.addEventListener('click', (e) => { e.preventDefault(); if(!gameOver) togglePause(); });
            btnPause.addEventListener('touchstart', (e) => { e.preventDefault(); if(!gameOver) togglePause(); });

            const btnReset = document.getElementById('btn-reset');
            btnReset.addEventListener('click', (e) => { e.preventDefault(); if(gameOver) restartGame(); });
            btnReset.addEventListener('touchstart', (e) => { e.preventDefault(); if(gameOver) restartGame(); });
        }

        // --- CÓDIGO DO PHASER ---

        const config = {
            type: Phaser.AUTO,
            parent: 'game-container', 
            width: 800,
            height: 600,
            backgroundColor: '#2d3436',
            scale: {
                // FIT: O jogo tenta preencher o máximo possível mantendo a proporção
                mode: Phaser.Scale.FIT,
                // CENTER_BOTH: Centraliza o canvas horizontalmente e verticalmente
                autoCenter: Phaser.Scale.CENTER_BOTH
            },
            physics: { default: 'arcade', arcade: { debug: false } },
            scene: { preload, create, update }
        };

        const game = new Phaser.Game(config);

        let player, cursors, keysWASD, keySpace, paredes, alimentos, inimigosPretos, npcsVermelhos, powerUps;
        let fome = 100, pontos = 0, vidas = 3, nivel = 1;
        let gameOver = false, isPaused = false;
        let fomeText, pontosText, vidasText, nivelText, msgText;
        let currentScene = null; 

        // Mapa mantido igual
        const mapaDesign = [
            [1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1],
            [1,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1],
            [1,0,1,0,1,0,1,1,1,1,0,1,1,1,1,1,0,1,0,1],
            [1,0,1,0,0,0,0,0,0,1,0,0,0,0,0,1,0,1,0,1],
            [1,0,1,1,1,1,1,1,0,1,1,1,1,1,0,1,0,1,0,1],
            [1,0,0,0,0,0,0,1,0,0,0,0,0,1,0,0,0,1,0,1],
            [1,1,1,1,1,1,0,1,1,1,1,1,0,1,1,1,1,1,0,1],
            [1,0,0,0,0,1,0,0,0,0,0,1,0,0,0,0,0,0,0,1],
            [1,0,1,1,0,1,1,1,1,1,0,1,1,1,1,1,1,1,0,1],
            [1,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,1],
            [1,0,1,0,1,1,1,1,1,1,1,1,1,1,1,1,0,1,0,1],
            [1,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1],
            [1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1],
            [1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1],
            [1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1]
        ];

        function preload() {
            this.load.image('boneco', 'hero_all_black.png');
            
            // Geradores de textura mantidos
            const genTex = (key, color, w, h) => {
                if(this.textures.exists(key)) return;
                let canvas = this.textures.createCanvas(key, w, h);
                canvas.context.fillStyle = color;
                canvas.context.fillRect(0, 0, w, h);
                canvas.context.strokeStyle = "rgba(0,0,0,0.3)";
                canvas.context.strokeRect(0, 0, w, h);
                canvas.refresh();
            };
            const genCirc = (key, color, r) => {
                if(this.textures.exists(key)) return;
                let canvas = this.textures.createCanvas(key, r*2, r*2);
                canvas.context.fillStyle = color;
                canvas.context.beginPath();
                canvas.context.arc(r, r, r, 0, Math.PI*2);
                canvas.context.fill();
                canvas.refresh();
            };

            genTex('wall', '#636e72', 40, 40);
            genCirc('food', '#2ecc71', 8);
            genTex('speedPower', '#00d2d3', 20, 20);
            genTex('npcRed', '#ff0000', 30, 30);
            genTex('npcBlack', '#000000', 30, 30);
        }

        function create() {
            currentScene = this;
            fome = 100; pontos = 0; vidas = 3; nivel = 1; gameOver = false; isPaused = false;
            
            if(isTouchDevice) document.getElementById('btn-reset').style.display = 'none';

            paredes = this.physics.add.staticGroup();
            mapaDesign.forEach((row, y) => {
                row.forEach((value, x) => {
                    if (value === 1) paredes.create(x * 40 + 20, y * 40 + 20, 'wall');
                });
            });

            player = this.physics.add.sprite(60, 60, 'boneco').setDisplaySize(38, 38);
            player.body.setSize(190, 250); // Ajustei hitbox para o tamanho real do sprite
            player.setCollideWorldBounds(true);
            this.physics.add.collider(player, paredes);

            alimentos = this.physics.add.group();
            inimigosPretos = this.physics.add.group();
            npcsVermelhos = this.physics.add.group();
            powerUps = this.physics.add.group();

            for(let i=0; i<6; i++) spawnItem(alimentos, 'food');
            adicionarNPC(this, 'npcRed'); 
            adicionarNPC(this, 'npcBlack'); 
            
            this.physics.add.overlap(player, alimentos, coletarComida, null, this);
            this.physics.add.overlap(player, inimigosPretos, levarDano, null, this);
            this.physics.add.collider(player, npcsVermelhos); 
            this.physics.add.overlap(player, powerUps, pegarPowerUp, null, this);
            this.physics.add.collider(inimigosPretos, paredes, resolverColisaoNPC, null, this);
            this.physics.add.collider(npcsVermelhos, paredes, resolverColisaoNPC, null, this);

            const style = { fontSize: '24px', fill: '#f1c40f', backgroundColor: '#000000aa', padding: {x:10, y:5} };
            fomeText = this.add.text(20, 20, 'FOME: 100%', { ...style, fill: '#2ecc71' });
            pontosText = this.add.text(780, 20, 'PONTOS: 0', style).setOrigin(1, 0);
            vidasText = this.add.text(400, 20, '❤️ ❤️ ❤️', { fontSize: '24px' }).setOrigin(0.5, 0);
            nivelText = this.add.text(400, 50, 'NÍVEL: 1', { fontSize: '16px', fill: '#fff' }).setOrigin(0.5, 0);
            
            msgText = this.add.text(400, 300, '', { fontSize: '40px', fill: '#fff', align: 'center', backgroundColor: '#e67e22', padding: {x:20, y:10} }).setOrigin(0.5).setDepth(100).setVisible(false);

            cursors = this.input.keyboard.createCursorKeys();
            keysWASD = this.input.keyboard.addKeys('W,A,S,D');
            keySpace = this.input.keyboard.addKey(Phaser.Input.Keyboard.KeyCodes.SPACE);

            this.time.addEvent({ delay: 1000, callback: () => { if(!isPaused && !gameOver) fome -= (1.2 + nivel*0.3); }, loop: true });
            this.time.addEvent({ delay: 3000, callback: randomizarTodosNPCs, loop: true });
        }

        function togglePause() {
            if(!currentScene) return;
            isPaused = !isPaused;
            if(isPaused) { 
                currentScene.physics.pause(); 
                msgText.setText('PAUSADO').setVisible(true); 
            } else { 
                currentScene.physics.resume(); 
                msgText.setVisible(false); 
            }
        }

        function restartGame() {
            if(!currentScene) return;
            currentScene.scene.restart();
        }

        function resolverColisaoNPC(npc, parede) {
            let baseVel = (npc.texture.key === 'npcBlack') ? 160 : 110;
            let angulo = Phaser.Math.Between(0, 3) * 90 + Phaser.Math.Between(-15, 15);
            this.physics.velocityFromAngle(angulo, baseVel, npc.body.velocity);
        }

        function randomizarTodosNPCs() {
            [inimigosPretos, npcsVermelhos].forEach(grupo => {
                grupo.getChildren().forEach(npc => {
                    let baseVel = (npc.texture.key === 'npcBlack') ? 160 : 110;
                    if(Math.random() > 0.4) {
                        npc.setVelocity(
                            Phaser.Utils.Array.GetRandom([-baseVel, baseVel]), 
                            Phaser.Utils.Array.GetRandom([-baseVel, baseVel])
                        );
                    }
                });
            });
        }

        function update() {
            if(gameOver) {
                if(Phaser.Input.Keyboard.JustDown(keySpace)) restartGame();
                return;
            }

            if(Phaser.Input.Keyboard.JustDown(keySpace)) togglePause();

            if(isPaused) return;

            let speed = player.isPowered ? 350 : 200;
            player.setVelocity(0);

            if (cursors.left.isDown || keysWASD.A.isDown || moveLeft) player.setVelocityX(-speed);
            else if (cursors.right.isDown || keysWASD.D.isDown || moveRight) player.setVelocityX(speed);
            
            if (cursors.up.isDown || keysWASD.W.isDown || moveUp) player.setVelocityY(-speed);
            else if (cursors.down.isDown || keysWASD.S.isDown || moveDown) player.setVelocityY(speed);

            fomeText.setText(`FOME: ${Math.floor(fome)}%`);
            if(fome <= 0) levarDano.call(this, player, null);
        }

        function spawnItem(grupo, tex) {
            let x, y, val = false;
            while(!val) {
                let r = Phaser.Math.Between(1, mapaDesign.length - 2);
                let c = Phaser.Math.Between(1, mapaDesign[0].length - 2);
                if(mapaDesign[r][c] === 0) {
                    x = c * 40 + 20; y = r * 40 + 20;
                    val = true;
                }
            }
            return grupo.create(x, y, tex);
        }

        function adicionarNPC(scene, tipo) {
            let grupo = (tipo === 'npcBlack' ? inimigosPretos : npcsVermelhos);
            let npc = spawnItem(grupo, tipo);
            npc.setBounce(1).setCollideWorldBounds(true);
            let vel = (tipo === 'npcBlack') ? 160 : 110;
            npc.setVelocity(Phaser.Utils.Array.GetRandom([-vel, vel]), Phaser.Utils.Array.GetRandom([-vel, vel]));
            if (tipo === 'npcRed') {
                npc.setImmovable(true);
                npc.body.setMass(100); 
            }
        }

        function coletarComida(p, f) {
            f.destroy();
            fome = Math.min(fome + 20, 100);
            pontos += 10;
            pontosText.setText('PONTOS: ' + pontos);
            if(pontos > 0 && pontos % 100 === 0) {
                nivel++;
                nivelText.setText('NÍVEL: ' + nivel);
                adicionarNPC(this, Math.random() > 0.5 ? 'npcRed' : 'npcBlack');
                spawnItem(powerUps, 'speedPower');
            }
            spawnItem(alimentos, 'food');
        }

        function levarDano(p, i) {
            if(p.isInvincible) return;
            vidas--;
            vidasText.setText('❤️ '.repeat(Math.max(0, vidas)));
            
            if(vidas <= 0) {
                gameOver = true;
                this.physics.pause();
                
                if (isTouchDevice) {
                    msgText.setText('VOCÊ MORREU!').setVisible(true);
                    document.getElementById('btn-reset').style.display = 'flex';
                } else {
                    msgText.setText('VOCÊ MORREU!\nESPAÇO PARA REINICIAR').setVisible(true);
                }

            } else {
                fome = 100;
                p.isInvincible = true;
                p.setAlpha(0.5);
                this.time.delayedCall(1500, () => { p.isInvincible = false; p.setAlpha(1); });
                if(i) p.setPosition(60, 60); 
            }
        }

        function pegarPowerUp(p, pw) {
            pw.destroy();
            player.isPowered = true;
            player.setTint(0x00ffff);
            this.time.delayedCall(6000, () => { player.isPowered = false; player.clearTint(); });
        }
    </script>
</body>
</html>